<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>CBT System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Roboto:wght@400;500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script>
    window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };
  </script>
  <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <style>
    :root { --primary-blue: #2962ff; --bg-gray: #f5f8fa; --anbk-header: #0f4c81; --anbk-bg: #889bb0; --anbk-bg-exam: #E8ECF0; --btn-next: #2c9aff; --btn-prev: #d32f2f; --btn-ragu: #eda50e; --btn-finish: #d9534f; }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg-gray); height: 100vh; overflow: hidden; margin: 0; user-select: none; }
    .app-view { display: none; height: 100vh; flex-direction: column; }
    
    /* LOGIN */
    #view-login { background: linear-gradient(135deg, #1e4bd1 0%, #0f4c81 100%); align-items: center; justify-content: center; padding: 20px; }
    .login-card { background: white; padding: 30px; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; transition: all 0.3s; }
    .login-toggle { cursor: pointer; color: var(--anbk-header); font-weight: 600; font-size: 0.9rem; text-decoration: none; }
    .login-toggle:hover { text-decoration: underline; }

    /* EXAM */
    #view-exam { font-family: 'Roboto', sans-serif; background-color: var(--anbk-bg-exam); }
    .header-anbk { background-color: var(--anbk-header); height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100; }
    .logo-area { display: flex; align-items: center; gap: 12px; }
    .logo-img { height: 45px; width: auto; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); }
    .header-titles { display: flex; flex-direction: column; justify-content: center; }
    .header-main-title { font-weight: 800; font-size: 18px; line-height: 1; letter-spacing: 0.5px; }
    .header-sub-title { font-size: 11px; opacity: 0.9; margin-top: 3px; font-weight: 400; letter-spacing: 1px; }
    .user-info-box { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2); }
    .user-name { font-weight: 500; font-size: 14px; }
    .btn-logout { color: white; opacity: 0.8; transition: 0.2s; font-size: 18px; } .btn-logout:hover { opacity: 1; transform: scale(1.1); }

    .anbk-container { flex: 1; margin: 15px 30px; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
    .soal-toolbar { padding: 15px 25px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: flex-start; background: #fff; }
    .pill-btn { border-radius: 20px; padding: 6px 18px; font-size: 12px; font-weight: 600; border: none; display: flex; align-items: center; gap: 6px; cursor: pointer; transition: 0.2s; }
    .btn-blue-outline { background: #2680eb; color: white; box-shadow: 0 2px 4px rgba(38, 128, 235, 0.3); }
    .btn-timer { background: #f1f3f5; border: 1px solid #ced4da; color: #333; min-width: 150px; justify-content: center; font-family: 'Inter', monospace; font-size: 14px; }
    
    .split-content { flex: 1; display: flex; overflow: hidden; background-image: url('https://upload.wikimedia.org/wikipedia/commons/b/b5/Tut_Wuri_Handayani.png'); background-repeat: no-repeat; background-position: right bottom; background-size: 300px; background-blend-mode: overlay; }
    .pane-left { flex: 0 0 45%; border-right: 3px dotted #ccc; padding: 25px; overflow-y: auto; background: rgba(255,255,255,0.96); }
    .pane-right { flex: 1; padding: 25px 35px; overflow-y: auto; background: rgba(255,255,255,0.9); }
    .soal-text { font-size: 16px; line-height: 1.7; color: #212529; margin-bottom: 25px; }
    .opsi-item { display: flex; align-items: flex-start; cursor: pointer; margin-bottom: 12px; color: #333; font-size: 15px; padding: 8px; border-radius: 5px; transition: background 0.1s; } .opsi-item:hover { background: #f8f9fa; }
    .opsi-item input { margin-right: 12px; width: 20px; height: 20px; flex-shrink: 0; margin-top: 3px; accent-color: #333; }
    .anbk-footer { padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border-top: 1px solid #eee; }
    .btn-nav { border: none; border-radius: 50px; padding: 10px 24px; font-weight: 600; font-size: 13px; color: white; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.1s; } .btn-nav:active { transform: translateY(1px); }
    .nav-prev { background-color: var(--btn-prev); } .nav-next { background-color: var(--btn-next); }
    .ragu-container { background-color: var(--btn-ragu); padding: 8px 20px; border-radius: 6px; display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 14px; color: #333; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    /* ADMIN */
    #view-admin { flex-direction: row; } 
    .sidebar { width: 250px; background: #212529; color: white; padding: 20px; display: flex; flex-direction: column; height: 100%; transition: 0.3s; z-index: 1040; }
    .sidebar .nav-link { color: #adb5bd; padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 5px;} .sidebar .nav-link.active { background: var(--primary-blue); color: white; }
    .admin-content { flex: 1; padding: 20px; overflow-y: auto; background: #f4f6f9; }
    .admin-section { display: none; } .admin-section.active { display: block; animation: fadeIn 0.3s; }
    .stat-card { background: white; padding: 15px; border-radius: 8px; border-left: 5px solid var(--primary-blue); }
    .grid-soal { display: grid; grid-template-columns: repeat(10, 1fr); gap: 10px; padding: 15px; }
    .item-soal { border: 1px solid #999; border-radius: 4px; height: 35px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; position: relative; }
    .item-soal.active { background: var(--primary-blue); color: white; } .item-soal.answered { background: #333; color: white; } .item-soal.ragu { background: var(--btn-ragu); color: black; }
    .badge-check { position: absolute; top: -5px; right: -5px; font-size: 10px; }
    @media (max-width: 768px) { .sidebar { position: fixed; left: -260px; height: 100vh; } .sidebar.open { left: 0; } .sidebar-overlay.open { display: block; } .header-anbk { padding: 0 15px; height: 60px; } .anbk-container { margin: 10px; height: calc(100vh - 80px); } .split-content { flex-direction: column; } .pane-left { flex: none; height: 30%; border-right: none; border-bottom: 2px dotted #ccc; } .btn-nav span { display: none; } .grid-soal { grid-template-columns: repeat(5, 1fr); } .user-info-box span { display: none; } }
  </style>
</head>
<body>

  <div id="view-login" class="app-view" style="display: flex;">
    <div class="login-card">
      <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/Tut_Wuri_Handayani.png" width="60" class="mb-3">
      <h4 class="mb-1" id="login-title">Login Peserta</h4>
      <p class="text-muted small mb-4">Silahkan masuk untuk memulai</p>
      <div class="form-floating mb-3"><input type="text" class="form-control" id="username" placeholder="User"><label>Username</label></div>
      <div class="form-floating mb-3"><input type="password" class="form-control" id="password" placeholder="Pass"><label>Password</label></div>
      <div id="container-selections">
        <div class="form-floating mb-4">
          <select class="form-select" id="select-mapel"><option value="" selected disabled>Loading...</option></select>
          <label>Mata Pelajaran</label>
        </div>
      </div>
      <button class="btn btn-primary w-100 py-2 rounded-pill fw-bold" onclick="doLogin()" id="btnLogin" style="background-color: var(--anbk-header); border: none;">MASUK</button>
      <div id="login-msg" class="text-danger mt-3 small"></div>
      <div class="mt-4 pt-3 border-top"><a onclick="toggleLoginMode()" class="login-toggle" id="toggle-text">Masuk sebagai Admin</a></div>
    </div>
  </div>

  <div id="view-exam" class="app-view">
    <nav class="header-anbk">
      <div class="logo-area"><img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/Tut_Wuri_Handayani.png" class="logo-img"><div class="header-titles"><div class="header-main-title">PUSMENDIK</div><div class="header-sub-title">APLIKASI ANBK</div></div></div>
      <div class="user-info-box"><i class="fas fa-user-circle fa-lg text-white"></i><span id="user-display" class="user-name">Peserta</span><div style="width: 1px; height: 15px; background: rgba(255,255,255,0.4); margin: 0 5px;"></div><a href="#" onclick="logout()" class="btn-logout" title="Keluar"><i class="fas fa-power-off"></i></a></div>
    </nav>
    <div class="anbk-container">
      <div class="soal-toolbar">
        <div class="left-tool"><h5 style="margin:0; font-weight:500; color:#333; font-size: 18px;">Soal nomor <span id="no-soal" style="font-weight:700;">1</span></h5><div style="font-size:12px; color:#666; margin-top:4px;">Ukuran font soal: <b>A A A</b></div></div>
        <div class="right-tool d-flex flex-column align-items-end">
          <div class="top-buttons d-flex gap-2"><button class="pill-btn btn-blue-outline" onclick="showInfo()">INFORMASI SOAL</button><div class="pill-btn btn-timer">Sisa Waktu : <span id="timer" class="ms-1">00:00</span></div><button class="pill-btn btn-blue-outline" onclick="showDaftarSoal()">Daftar Soal <i class="fas fa-th-large ms-1"></i></button></div>
          <div id="subject-display" style="font-size:14px; font-weight:800; margin-top:10px; color:#222; text-transform:uppercase; letter-spacing: 0.5px;">...</div>
        </div>
      </div>
      <div class="split-content">
        <div class="pane-left"><div id="wacana-area" style="display:none;"></div></div>
        <div class="pane-right"><div id="soal-text" class="soal-text">Loading...</div><div id="jawaban-area" class="opsi-group"></div></div>
      </div>
      <div class="anbk-footer">
        <button class="btn-nav nav-prev" onclick="navSoal(-1)" id="btn-prev"><i class="fas fa-chevron-left"></i> <span>Soal sebelumnya</span></button>
        <label class="ragu-container"><input type="checkbox" id="ragu" class="ragu-checkbox" onchange="toggleRagu()"><span>Ragu-ragu</span></label>
        <button class="btn-nav nav-next" onclick="navSoal(1)" id="btn-next"><span>Soal berikutnya</span> <i class="fas fa-chevron-right"></i></button>
      </div>
    </div>
  </div>

  <div id="view-admin" class="app-view">
    <div class="d-md-none bg-dark text-white p-2 d-flex justify-content-between"><div class="fw-bold">Admin Panel</div><button class="btn btn-sm btn-outline-light" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button></div>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="adminSidebar">
      <h4 class="mb-4 text-white">Admin CBT</h4>
      <a onclick="menu('dashboard')" class="nav-link active" id="m-dashboard"><i class="fas fa-home me-2"></i>Dashboard</a>
      <a onclick="menu('peserta')" class="nav-link" id="m-peserta"><i class="fas fa-users me-2"></i>Peserta</a>
      <a onclick="menu('soal')" class="nav-link" id="m-soal"><i class="fas fa-database me-2"></i>Bank Soal</a>
      <a onclick="menu('hasil')" class="nav-link" id="m-hasil"><i class="fas fa-poll me-2"></i>Hasil Ujian</a>
      <a onclick="menu('monitoring')" class="nav-link" id="m-monitoring"><i class="fas fa-desktop me-2"></i>Monitoring</a>
      <div class="mt-auto"><a href="#" class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Keluar</a></div>
    </div>
    <div class="admin-content">
      <div id="sec-dashboard" class="admin-section active">
        <h4 class="mb-3">Dashboard</h4>
        <div class="row g-3">
           <div class="col-md-4"><div class="stat-card"><h6>Siswa</h6><h2 id="s-users">0</h2></div></div>
           <div class="col-md-4"><div class="stat-card"><h6>Soal</h6><h2 id="s-soal">0</h2></div></div>
           <div class="col-md-4"><div class="stat-card"><h6>Hasil</h6><h2 id="s-hasil">0</h2></div></div>
        </div>
      </div>
      <div id="sec-peserta" class="admin-section">
        <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
          <h4>Manajemen Peserta</h4>
          <div class="d-flex gap-2">
            <div class="input-group input-group-sm" style="width: 250px;">
              <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
              <input type="text" id="search-peserta" class="form-control" placeholder="Cari Nama atau Username..." onkeyup="filterTabelPeserta()">
            </div>
            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalAddUser">
              <i class="fas fa-plus"></i> Tambah Siswa
            </button>
          </div>
        </div>
        <div class="card p-0 shadow-sm">
          <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
              <thead class="table-light"><tr><th>Username</th><th>Nama</th><th>Prodi</th><th style="width:150px;">Aksi</th></tr></thead>
              <tbody id="tb-peserta"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="sec-soal" class="admin-section">
        <div class="d-flex justify-content-between mb-3"><h4>Bank Soal</h4><div><button class="btn btn-primary btn-sm" onclick="downloadTemplate()">Template</button> <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalUpload">Upload</button></div></div>
        <div class="card p-0 shadow-sm"><div class="table-responsive"><table class="table table-hover mb-0"><thead class="table-light"><tr><th>ID</th><th>Tipe</th><th>Soal</th></tr></thead><tbody id="tb-soal"></tbody></table></div></div>
      </div>
      <div id="sec-hasil" class="admin-section">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
          <h4 class="mb-0">Hasil Ujian</h4>
          <div class="d-flex gap-2">
            <select class="form-select form-select-sm" id="filter-mapel" style="width:150px"><option value="">Semua Mapel</option></select>
            <select class="form-select form-select-sm" id="filter-prodi" style="width:150px"><option value="">Semua Prodi</option></select>
            <button class="btn btn-success btn-sm" onclick="loadTable('hasil')"><i class="fas fa-sync"></i></button>
            <button class="btn btn-primary btn-sm" onclick="downloadCSV()"><i class="fas fa-download"></i> Unduh CSV</button>
          </div>
        </div>
        <div class="card p-0 shadow-sm"><div class="table-responsive"><table class="table table-striped mb-0 align-middle"><thead class="table-dark"><tr><th>User</th><th>Nama</th><th>Waktu</th><th>Mapel</th><th>Prodi</th><th>Nilai</th><th class="text-center" style="width:100px;">Aksi</th></tr></thead><tbody id="tb-hasil"></tbody></table></div></div>
      </div>
      <div id="sec-monitoring" class="admin-section">
        <div class="d-flex justify-content-between align-items-center mb-3"><h4 class="mb-0">Live Monitoring</h4><div><span class="badge bg-info me-2"><i class="fas fa-clock"></i> Auto 10s</span><button class="btn btn-warning btn-sm" onclick="google.script.run.resetMonitoring(); loadMonitoring();">Reset Data</button></div></div>
        <div class="card p-0 shadow-sm"><div class="table-responsive"><table class="table table-bordered mb-0"><thead class="table-dark"><tr><th>Nama</th><th>Progres</th><th>Mapel</th><th>Status</th></tr></thead><tbody id="tb-monitoring"></tbody></table></div></div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalKonfirmasiTes" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius:22px;border:none;box-shadow:0 18px 45px rgba(0,0,0,0.35);overflow:hidden;">
        <div class="modal-body p-0" style="position:relative;background-color:white;">
          <div style="position:absolute;top:0;left:0;width:100%;height:100%;background-image:url('https://upload.wikimedia.org/wikipedia/commons/b/b5/Tut_Wuri_Handayani.png');background-repeat:no-repeat;background-position:120% 120%;background-size:300px;opacity:0.1;pointer-events:none;"></div>
          <div style="padding:40px 30px;position:relative;z-index:2;">
            <h3 class="fw-bold mb-3" style="color:#212529;font-family:'Roboto',sans-serif;">Konfirmasi Tes</h3>
            <p class="mb-4" style="color:#212529;font-size:16px;line-height:1.6;font-family:'Roboto',sans-serif;">Terimakasih telah berpartisipasi dalam tes ini.<br>Silahkan tekan tombol <span style="background-color:#dc3545;color:white;padding:2px 6px;font-weight:500;">SELESAI TES</span> untuk mengakhiri tes. Atau tekan tombol <span style="background-color:#198754;color:white;padding:2px 6px;font-weight:500;">KEMBALI</span> untuk kembali ke halaman tes.</p>
            <div class="d-flex justify-content-center gap-3" id="confirm-buttons">
              <button class="btn btn-danger rounded-pill px-4 py-2" style="font-size:14px;font-weight:600;min-width:140px;" onclick="submitReal()">SELESAI TES</button>
              <button class="btn btn-success rounded-pill px-4 py-2" style="font-size:14px;font-weight:600;min-width:140px;" data-bs-dismiss="modal">KEMBALI</button>
            </div>
            <div id="sending-progress" class="d-none mt-4 text-center"><i class="fas fa-spinner fa-spin fa-2x text-primary mb-2"></i><p class="text-muted small m-0">Sedang mengirim jawaban...</p></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalPeringatan" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius:22px;border:none;box-shadow:0 18px 45px rgba(0,0,0,0.35);overflow:hidden;">
        <div class="modal-body pt-4 pb-4 px-5 text-center">
          <h3 class="fw-bold mb-3" style="color:#dc3545;font-size:24px;font-family:'Roboto',sans-serif;" id="judul-peringatan">PERINGATAN KERAS!</h3>
          <p class="mb-3" style="font-size:16px;line-height:1.5;color:#333;font-family:'Roboto',sans-serif;"><span id="pesan-peringatan-body">Dilarang berpindah tab atau membuka jendela baru. Jika hal ini berulang, maka secara otomatis ujian akan berakhir dan jawaban Anda akan <span style="background-color:#dc3545;color:white;padding:1px 5px;font-weight:bold;">DIKIRIM OTOMATIS</span> ke server.</span></p>
          <p id="sisa-peringatan" style="color:#dc3545;font-weight:bold;font-size:16px;margin-bottom:25px;">(Sisa Toleransi: 2x lagi)</p>
          <div id="btn-container-peringatan"><button class="btn btn-success rounded-pill px-5 fw-bold" onclick="tutupPeringatan()">SAYA MENGERTI</button></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalWaktuHabis" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius:22px;border:none;box-shadow:0 18px 45px rgba(0,0,0,0.35);overflow:hidden;">
        <div class="modal-body pt-4 pb-4 px-5 text-center">
          <h3 class="fw-bold mb-3" style="color:#dc3545;font-size:24px;font-family:'Roboto',sans-serif;">UJIAN BERAKHIR</h3>
          <p class="mb-4" style="font-size:16px;line-height:1.5;color:#333;font-family:'Roboto',sans-serif;">Waktu ujian telah habis atau Anda telah melakukan pelanggaran berat. Jawaban Anda telah <span style="background-color:#dc3545;color:white;padding:1px 5px;font-weight:bold;">DIKIRIM OTOMATIS</span> ke server.</p>
          <div class="d-flex justify-content-center"><button class="btn btn-success rounded-pill px-5 fw-bold" onclick="tutupWaktuHabis()">SAYA MENGERTI</button></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalInfoSoal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-light"><h6 class="modal-title fw-bold">Informasi Soal</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" style="min-height:100px;"></div></div></div></div>
  <div class="modal fade" id="modalUpload"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Upload CSV</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input class="form-control" type="file" id="fileCsvInput"><div id="upload-status" class="alert alert-info d-none mt-2"></div></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="processUpload()">Upload</button></div></div></div></div>
  <div class="modal fade" id="modalAddUser"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Tambah Siswa Baru</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><label class="small text-muted mb-1">Username</label><input id="newU" class="form-control mb-2" placeholder="Contoh: 1001"><label class="small text-muted mb-1">Password</label><input id="newP" class="form-control mb-2" placeholder="Contoh: 12345"><label class="small text-muted mb-1">Nama Lengkap</label><input id="newN" class="form-control mb-2" placeholder="Contoh: Budi Santoso"><label class="small text-muted mb-1">Program Studi</label><input id="newPr" class="form-control mb-2" placeholder="Contoh: IPA / IPS / TEKNIK"></div><div class="modal-footer"><button onclick="saveNewUser()" class="btn btn-primary">Simpan Data</button></div></div></div></div>
  
  <div class="modal fade" id="modalDaftarSoal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content" style="border-radius:18px;border:none;box-shadow:0 10px 30px rgba(0,0,0,0.3);">
        <div class="modal-header border-0"><h5 class="modal-title fw-bold">Daftar Soal</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><div id="grid-soal-container" class="grid-soal"></div></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- VARIABEL GLOBAL ---
    let user={}, soal=[], idx=0, ans={}, raguMap={}, violationCount=0;
    let modalKonfirmasiTes, modalDaftarSoal, modalInfoSoal, modalPeringatan, modalWaktuHabis, modalAddUser;
    let timerInterval, syncInterval, monitorInterval;
    let isAdminMode = false;
    let currentMapel = "", currentProdi = "";
    let allPeserta = []; // Simpan data mentah peserta untuk fitur pencarian

    // --- LOGIKA TAMPILAN & LOGIN ---
    function toggleLoginMode() {
      isAdminMode = !isAdminMode;
      const title = document.getElementById('login-title');
      const toggleTxt = document.getElementById('toggle-text');
      const containerSel = document.getElementById('container-selections');
      if (isAdminMode) { 
        title.innerText = "Login Admin"; 
        toggleTxt.innerText = "Masuk sebagai Peserta"; 
        containerSel.style.display = 'none'; 
      } else { 
        title.innerText = "Login Peserta"; 
        toggleTxt.innerText = "Masuk sebagai Admin"; 
        containerSel.style.display = 'block'; 
      }
    }

    window.onload = function() {
      google.script.run.withSuccessHandler(data => {
        const selMapel = document.getElementById('select-mapel');
        selMapel.innerHTML = '<option value="" selected disabled>Pilih Mata Pelajaran...</option>';
        data.mapel.forEach(m => { let opt = document.createElement('option'); opt.value = m; opt.innerText = m; selMapel.appendChild(opt); });
        const filterMapel = document.getElementById('filter-mapel');
        data.mapel.forEach(m => { let opt = document.createElement('option'); opt.value = m; opt.innerText = m; filterMapel.appendChild(opt); });
        const filterProdi = document.getElementById('filter-prodi');
        data.prodi.forEach(p => { let opt = document.createElement('option'); opt.value = p; opt.innerText = p; filterProdi.appendChild(opt); });
      }).getConfigData();
    };

    // --- KEAMANAN (ANTI-CURANG) ---
    function initSecurity() { document.addEventListener("visibilitychange", handleVis); }
    function handleVis() {
      if(document.getElementById('view-exam').style.display !== 'flex') return;
      if(document.hidden) {
        violationCount++; const sisa = 3 - violationCount;
        if(!modalPeringatan) modalPeringatan = new bootstrap.Modal(document.getElementById('modalPeringatan'));
        if(violationCount < 3) { 
          document.getElementById('sisa-peringatan').innerText = `(Sisa Toleransi: ${sisa}x lagi)`; 
          modalPeringatan.show(); 
        } 
        else { 
          if(modalPeringatan) modalPeringatan.hide(); 
          submitReal(true); 
        }
      }
    }
    function tutupPeringatan() { if(modalPeringatan) modalPeringatan.hide(); }
    function tutupWaktuHabis() { if(modalWaktuHabis) modalWaktuHabis.hide(); logoutForce(); }
    function showPage(p){ document.querySelectorAll('.app-view').forEach(e=>e.style.display='none'); document.getElementById(p).style.display='flex'; if(p==='view-admin')document.getElementById('view-admin').style.flexDirection='row'; }
    
    function doLogin(){
      const u=document.getElementById('username').value, p=document.getElementById('password').value;
      const m=document.getElementById('select-mapel').value;
      if(!u||!p) return alert("Isi Username & Password!");
      if (!isAdminMode) { if (!m) return alert("Pilih Mata Pelajaran!"); currentMapel = m; } else { currentMapel = ""; }
      document.getElementById('btnLogin').innerHTML='Loading...';
      google.script.run.withSuccessHandler(res=>{
        document.getElementById('btnLogin').innerHTML='MASUK';
        if(res.status==='success'){ 
           user=res.data; currentProdi = user.prodi;
           if(user.role==='admin') { initAdmin(); } 
           else { 
              if(res.savedAnswers && Object.keys(res.savedAnswers).length > 0){ 
                 ans = res.savedAnswers; if(confirm("Ditemukan jawaban tersimpan sebelumnya. Lanjutkan ujian?")) { initExam(); } else { ans={}; initExam(); } 
              } else { initExam(); } 
           } 
        } else document.getElementById('login-msg').innerText=res.message;
      }).loginUser(u,p,currentMapel);
    }

    function logoutForce(){ 
      clearInterval(timerInterval); clearInterval(syncInterval); clearInterval(monitorInterval);
      document.removeEventListener("visibilitychange", handleVis);
      user={}; ans={}; idx=0; violationCount=0; currentMapel=""; currentProdi="";
      document.getElementById('username').value=''; document.getElementById('password').value='';
      if(modalPeringatan) modalPeringatan.hide(); if(modalWaktuHabis) modalWaktuHabis.hide(); if(modalKonfirmasiTes) modalKonfirmasiTes.hide();
      isAdminMode = true; toggleLoginMode(); showPage('view-login');
    }
    function logout(){ if(confirm("Keluar?")) logoutForce(); }

    function initExam(){
      showPage('view-exam'); 
      document.getElementById('user-display').innerText = user.nama.split(' ')[0]; 
      document.getElementById('subject-display').innerText = currentMapel; 
      initSecurity(); // Mode peringatan tetap ada

      google.script.run.withSuccessHandler(res => {
        soal = res; 
        if (soal.length === 0) { alert('Soal mapel ini belum tersedia.'); logoutForce(); return; }
        renderSoal(0);
        startTimer(7200); 
        startSync();
      }).getSoal(currentMapel);
    }

    function startSync(){ if(syncInterval)clearInterval(syncInterval); syncInterval=setInterval(()=>{google.script.run.syncProgress(user,Object.keys(ans).length,soal.length,'Mengerjakan', ans, currentProdi, currentMapel);},20000); }
    function navSoal(n) { renderSoal(idx + n); }

    function renderSoal(i) {
      if (i < 0 || i >= soal.length) return;
      idx = i;
      const d = soal[idx];
      document.getElementById('no-soal').innerText = idx + 1;
      const w = document.getElementById('wacana-area');
      if (d.wacana) { w.innerHTML = d.wacana; w.style.display = 'block'; } else w.style.display = 'none';
      let html = '';
      if (d.gambar && d.gambar.trim() !== "") { html += `<div class="text-center mb-3"><img src="${d.gambar}" class="img-fluid rounded border p-1" style="max-height:300px;"></div>`; }
      html += `<div style="font-size:16px; margin-bottom:15px;">${d.soal}</div>`;
      document.getElementById('soal-text').innerHTML = html;
      const a = document.getElementById('jawaban-area');
      a.innerHTML = '';
      let savedVal = ans[d.id] || '';
      if (d.tipe === 'isian' || d.tipe === 'essay') { a.innerHTML = `<label class="form-label fw-bold">Jawaban Anda:</label><textarea id="input-${d.id}" class="form-control" rows="5" placeholder="Ketik jawaban di sini..." style="resize:none;" oninput="inputEssay('${d.id}', this.value)">${savedVal}</textarea>`; } 
      else if (d.tipe === 'bs') {
          let currentAns = savedVal ? savedVal.split(',') : new Array(d.opsi.length).fill('');
          let tableHTML = `<table class="table table-bordered table-striped align-middle mb-0"><thead class="table-dark text-center"><tr><th>Pernyataan</th><th style="width:80px;">Benar</th><th style="width:80px;">Salah</th></tr></thead><tbody>`;
          d.opsi.forEach((o, index) => {
             let chkB = currentAns[index] === 'B' ? 'checked' : '';
             let chkS = currentAns[index] === 'S' ? 'checked' : '';
             tableHTML += `<tr><td>${o.text}</td><td class="text-center"><input class="form-check-input" type="radio" name="bs-${d.id}-${index}" value="B" ${chkB} onclick="selectBS('${d.id}', ${index}, 'B', ${d.opsi.length})"></td><td class="text-center"><input class="form-check-input" type="radio" name="bs-${d.id}-${index}" value="S" ${chkS} onclick="selectBS('${d.id}', ${index}, 'S', ${d.opsi.length})"></td></tr>`;
          });
          tableHTML += `</tbody></table>`;
          a.innerHTML = tableHTML;
      } else if (d.tipe === 'ganda') {
          let currentList = savedVal ? savedVal.split(',') : [];
          a.innerHTML = '<div class="alert alert-info py-2 mb-2 small"><i class="fas fa-info-circle"></i> Pilih lebih dari satu jawaban.</div>';
          d.opsi.forEach(o => {
             let chk = currentList.includes(o.id) ? 'checked' : '';
             a.innerHTML += `<div class="opsi-item" onclick="selectCheckbox('${d.id}','${o.id}')"><input type="checkbox" value="${o.id}" ${chk} style="margin-right:12px; width:20px; height:20px; accent-color:#333;"><div>${o.text}</div></div>`;
          });
      } else {
          d.opsi.forEach(o => {
            const chk = savedVal === o.id ? 'checked' : '';
            a.innerHTML += `<div class="opsi-item" onclick="selectRadio('${d.id}','${o.id}')"><input type="radio" name="pg" value="${o.id}" ${chk}><div>${o.text}</div></div>`;
          });
      }
      document.getElementById('ragu').checked = raguMap[d.id] || false;
      updateNav();
      if (window.MathJax && window.MathJax.typesetPromise) { window.MathJax.typesetPromise().catch(e => console.log('MathJax Error:', e)); }
    }

    function inputEssay(qid, val) { ans[qid] = val; }
    function selectBS(qid, index, val, total) { let current = ans[qid] ? ans[qid].split(',') : new Array(total).fill('?'); if(current.length < total) current = new Array(total).fill('?'); current[index] = val; ans[qid] = current.join(','); }
    function selectCheckbox(qid, oid) { let currentList = ans[qid] ? ans[qid].split(',') : []; if (currentList.includes(oid)) { currentList = currentList.filter(item => item !== oid); } else { currentList.push(oid); } currentList.sort(); ans[qid] = currentList.join(','); renderSoal(idx); }
    function selectRadio(qid,oid){ document.querySelector(`input[name="pg"][value="${oid}"]`).checked=true; ans[qid]=oid; }
    function toggleRagu(){ raguMap[soal[idx].id]=document.getElementById('ragu').checked; }
    function updateNav(){
      const b=document.getElementById('btn-next'); document.getElementById('btn-prev').disabled=(idx===0);
      b.innerHTML='<span>Soal berikutnya</span> <i class="fas fa-chevron-right"></i>'; b.className='btn-nav nav-next'; b.onclick=()=>renderSoal(idx+1);
      if(idx===soal.length-1){ b.innerHTML='<span>Selesai</span> <i class="fas fa-check"></i>'; b.onclick=()=>finishExam(); }
    }
    function finishExam(){ if(!modalKonfirmasiTes) modalKonfirmasiTes=new bootstrap.Modal(document.getElementById('modalKonfirmasiTes')); document.getElementById('confirm-buttons').classList.remove('d-none'); document.getElementById('sending-progress').classList.add('d-none'); modalKonfirmasiTes.show(); }
    function submitReal(forced=false){
      document.getElementById('confirm-buttons').classList.add('d-none'); document.getElementById('sending-progress').classList.remove('d-none');
      clearInterval(syncInterval); clearInterval(timerInterval); document.removeEventListener("visibilitychange", handleVis);
      google.script.run.syncProgress(user,Object.keys(ans).length,soal.length,'Selesai', ans, currentProdi, currentMapel);
      google.script.run.withSuccessHandler(r=>{
        if(r.status==='success'){ if(modalKonfirmasiTes) modalKonfirmasiTes.hide(); if(forced) { if(!modalWaktuHabis) modalWaktuHabis = new bootstrap.Modal(document.getElementById('modalWaktuHabis')); modalWaktuHabis.show(); } else { logoutForce(); } }
        else { alert('Gagal: ' + r.message); document.getElementById('confirm-buttons').classList.remove('d-none'); }
      }).submitUjian(ans, user, currentMapel, currentProdi);
    }
    function startTimer(t){ if(timerInterval)clearInterval(timerInterval); timerInterval=setInterval(()=>{ let m=parseInt(t/60),s=parseInt(t%60); document.getElementById('timer').innerText=`${m}:${s<10?'0'+s:s}`; if(--t<0){ clearInterval(timerInterval); submitReal(true); } },1000); }
    function showInfo(){ if(!modalInfoSoal)modalInfoSoal=new bootstrap.Modal(document.getElementById('modalInfoSoal')); modalInfoSoal.show(); }
    function showDaftarSoal() {
      if (!Array.isArray(soal) || soal.length === 0) { alert('Soal belum siap.'); return; }
      const modalEl = document.getElementById('modalDaftarSoal'); const grid = document.getElementById('grid-soal-container');
      grid.innerHTML = '';
      for (let i = 0; i < soal.length; i++) {
        const s = soal[i]; let cls = 'item-soal';
        if (i === idx) cls += ' active'; else if (raguMap[s.id]) cls += ' ragu'; else if (ans[s.id]) cls += ' answered';
        grid.innerHTML += `<div class="${cls}" data-i="${i}">${i + 1}</div>`;
      }
      grid.querySelectorAll('.item-soal').forEach(el => { el.onclick = function () { const i = parseInt(this.getAttribute('data-i')); renderSoal(i); bootstrap.Modal.getInstance(modalEl).hide(); }; });
      new bootstrap.Modal(modalEl).show();
    }

    function toggleSidebar(){ document.getElementById('adminSidebar').classList.toggle('open'); document.querySelector('.sidebar-overlay').classList.toggle('open'); }
    function menu(m){ if(monitorInterval){clearInterval(monitorInterval);monitorInterval=null;} document.querySelectorAll('.admin-section').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.sidebar .nav-link').forEach(e=>e.classList.remove('active')); document.getElementById('sec-'+m).classList.add('active'); document.getElementById('m-'+m).classList.add('active'); if(window.innerWidth<768)toggleSidebar(); if(m==='peserta') loadPeserta(); if(m==='soal' || m==='hasil') loadTable(m); if(m==='monitoring'){ loadMonitoring(); monitorInterval=setInterval(loadMonitoring,10000); } }
    function initAdmin(){ showPage('view-admin'); google.script.run.withSuccessHandler(s=>{document.getElementById('s-users').innerText=s.users;document.getElementById('s-soal').innerText=s.soal;document.getElementById('s-hasil').innerText=s.hasil;}).getAdminStats(); }

    /* --- FITUR PENCARIAN PESERTA --- */
    function loadPeserta() { 
      const tb=document.getElementById('tb-peserta'); tb.innerHTML='<tr><td colspan="4">Loading...</td></tr>'; 
      google.script.run.withSuccessHandler(data => { 
        allPeserta = data; 
        renderTabelPeserta(data); 
      }).adminGetUsers(); 
    }

    function renderTabelPeserta(data) {
      const tb=document.getElementById('tb-peserta'); let html = '';
      if (!data || data.length === 0) { tb.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Data tidak ditemukan</td></tr>'; return; }
      data.forEach(u => { 
        html += `<tr><td>${u.u}</td><td>${u.n}</td><td>${u.prodi}</td><td><button onclick="resetLogin('${u.u}', '${u.n}')" class="btn btn-warning btn-sm py-0 mb-1" title="Reset Login"><i class="fas fa-sync-alt"></i></button><button onclick="delUser('${u.u}')" class="btn btn-danger btn-sm py-0 mb-1" title="Hapus User"><i class="fas fa-trash"></i></button></td></tr>`; 
      }); 
      tb.innerHTML = html;
    }

    function filterTabelPeserta() {
      const keyword = document.getElementById('search-peserta').value.toLowerCase();
      const filtered = allPeserta.filter(p => 
        String(p.u).toLowerCase().includes(keyword) || 
        String(p.n).toLowerCase().includes(keyword)
      );
      renderTabelPeserta(filtered);
    }

    function saveNewUser() { let u = document.getElementById('newU').value; let p = document.getElementById('newP').value; let n = document.getElementById('newN').value; let pr = document.getElementById('newPr').value; if(!u || !p || !n) return alert("Data belum lengkap"); google.script.run.withSuccessHandler(r => { if(r.status=='success') { alert('Berhasil menambah siswa'); bootstrap.Modal.getInstance(document.getElementById('modalAddUser')).hide(); loadPeserta(); document.getElementById('newU').value=""; document.getElementById('newP').value=""; document.getElementById('newN').value=""; document.getElementById('newPr').value=""; } else alert(r.message); }).adminAddUser(u,p,n,pr); }
    function delUser(u) { if(confirm('Yakin menghapus user ini selamanya?')) { google.script.run.withSuccessHandler(r => { if(r.status=='success') loadPeserta(); else alert(r.message); }).adminDeleteUser(u); } }
    function loadTable(type){ const tb=document.getElementById('tb-'+type); tb.innerHTML='<tr><td colspan="7">Loading...</td></tr>'; if(type==='hasil') { const fMapel = document.getElementById('filter-mapel').value; const fProdi = document.getElementById('filter-prodi').value; google.script.run.withSuccessHandler(dt => { tb.innerHTML = ''; if(dt.length === 0) { tb.innerHTML='<tr><td colspan="7">Data Kosong</td></tr>'; return; } dt.forEach(r => { tb.innerHTML += `<tr><td>${r.username}</td><td>${r.nama}</td><td>${r.waktu}</td><td>${r.mapel}</td><td>${r.prodi}</td><td><span class="badge bg-primary">${r.skor}</span></td><td class="text-center"><button class="btn btn-sm btn-danger" onclick="resetLogin('${r.username}','${r.nama}')"><i class="fas fa-trash"></i> Reset</button></td></tr>`; }); }).getReportData(fMapel, fProdi); } else { google.script.run.withSuccessHandler(dt=>{ tb.innerHTML=''; if(dt.length===0) { tb.innerHTML='<tr><td colspan="5">Data Kosong</td></tr>'; return; } dt.forEach(r=>{ tb.innerHTML+=`<tr><td>${r.id}</td><td>${r.tipe}</td><td>${r.soal}</td></tr>`; }); }).getSoalDataForAdmin(); } }
    function downloadCSV() { const fMapel = document.getElementById('filter-mapel').value; const fProdi = document.getElementById('filter-prodi').value; google.script.run.withSuccessHandler(res => { if(res.status === 'success') { const a = document.createElement('a'); a.href = window.URL.createObjectURL(new Blob([res.csv], { type: 'text/csv' })); a.download = `Hasil_${fMapel}_${fProdi}.csv`; a.click(); } else { alert(res.message); } }).downloadReportCSV(fMapel, fProdi); }
    function resetLogin(u,n){ if(confirm(`Reset data ujian ${n}?`)) google.script.run.withSuccessHandler(r=>{alert(r.message);loadTable('hasil'); loadPeserta();}).resetLoginSiswa(u); }
    function loadMonitoring(){ const tb=document.getElementById('tb-monitoring'); google.script.run.withSuccessHandler(d=>{ let h=''; d.forEach(r=>{ let bg=r.status==='Online'?'bg-success':(r.status==='Selesai'?'bg-primary':'bg-danger'); h+=`<tr><td>${r.nama}</td><td>${r.terjawab}/${r.total}</td><td>${r.mapel}</td><td><span class="badge ${bg}">${r.status}</span></td></tr>`; }); tb.innerHTML=h||'<tr><td colspan="4">Kosong</td></tr>'; }).getMonitoringData(); }
    function downloadTemplate(){ let l=document.createElement("a"); l.href=URL.createObjectURL(new Blob(["ID,Tipe,Wacana,Soal,A,B,C,D,E,Gambar,Kunci\nS1,pg,,Contoh?,A,B,C,D,E,,A"],{type:'text/csv'})); l.download="template_v2.csv"; l.click(); }
    function processUpload(){ const f=document.getElementById('fileCsvInput').files[0]; if(!f)return alert("Pilih CSV"); const r=new FileReader(); r.onload=e=>google.script.run.withSuccessHandler(res=>{alert(res.status==='success'?'Sukses':'Gagal');loadTable('soal');bootstrap.Modal.getInstance(document.getElementById('modalUpload')).hide();}).uploadSoalCSV(e.target.result); r.readAsText(f); }
  </script>
</body>
</html>